---
title: "DRAFT"
author: "Alima Dzhanybaeva"
date: "2022-10-31"
output:
  pdf_document:
         latex_engine: xelatex
  html_document: default
---
```{r include=FALSE}
library(tidyverse)
library(modelsummary)
library(dplyr)
library(knitr)
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```
## 1.1 Overview of the original data.
### The original hotels-europe data includes information on price and features of hotels in 46 European cities and for 2017-2018. The data was downloaded from https://osf.io/yzntm/download.

```{r include=FALSE}
variables <- c('hotel_id','accommodation_type', 'addresscountryname', 'weekend', 'holiday',
               'center1distance', 'starrating', 'guestreviewrating', 'price', 'price_night',
               'year', 'month')
info <- c('Hotel ID', 'Type of accomodation', 'Country', 'Flag, if day is a weekend',
          'Flag, if day is a public holiday', 'Distance from main city center',
          'Number of stars', 'User rating average', 'Price in EUR', 'Number of nights',
          'Year (YYYY)', 'Month (MM)')
type <- c('numeric', 'string', 'string', 'binary', 'binary', 'string',
          'numeric', 'string', 'numeric', 'string', 'numeric', 'numeric')
description <- data.frame(variables, info, type)
```
```{r echo=FALSE}
kable(description, caption = "Description of the main variables in the original dataset")
```

### • Some value are non-zero but include zeros. The next table checks the zero values and the quantity of unique values.
```{r include=FALSE}
df <- read.csv('https://osf.io/yzntm/download')
```
```{r}
kable(funModeling::df_status(df))
```

## 1.2 Dataset for 7 Central European countries
### • For our analysis we used 7 Central European countries: Czech Republic, Germany, Italy, Hungary, Austria, Poland, Slovakia.
```{r}
df2 <- df %>% filter(addresscountryname %in% 
                       c('Czech Republic', 'Germany', 'Italy', 
                         'Hungary', 'Austria', 'Poland', 'Slovakia'))

```

### • The folowing manipulations were carried out on the original data to change the existing variables and to add new ones:
* The type of the variables *center1distance* and *guestreviewsrating* were changed from 'string' to 'numeric'. The new variable names are *distance* and *actualrating * respectively.
```{r include=FALSE}
# guestreviewrating separation
df2 <- separate(df2, guestreviewsrating, ' /', into =
                 c('actualrating', 'rate'))
df2 <- select(df2, -rate)
df2$actualrating <- as.numeric(df2$actualrating)

# Distance
df2 <- separate(df2, center1distance, ' ', into =
                  c('distance', 'miles'))
df2 <- select(df2, -miles)
df2$distance <- as.numeric(df2$distance)

df2$country <- as.factor(df2$addresscountryname)
df2 <- select(df2, -addresscountryname)
```
* The original *accommodationtype* variable was tranformed into new *acctype_f* factor variable.
```{r}
df2 <- separate(df2, accommodationtype, '@', into = 
                 c('word', 'acctype'))
df2 <- select(df2, -word)
df2 <- mutate(df2, acctype_f = factor(acctype))
```
* *trueprice* variable was generated by dividing the original *price* variable by *price_night*
```{r}
df2 <- separate(df2, price_night, ' ', into =
                     c('pr','word', 'nights', 'night'))
df2 <- select(df2, -pr)
df2 <- select(df2, -night)
df2 <- select(df2, -word)
df2$nights <- as.numeric(df2$nights)
df2$trueprice <- df2$price/df2$nights
```
* *season* variable was created based on the *month* variable
```{r}
df2 <- df2 %>%
  mutate(season = case_when(month == 12 | month == 1 |month == 2 ~ 'winter',
                            month == 3 | month == 4 |month == 5 ~ 'spring',
                            month == 6 | month == 7 |month == 8 ~ 'summer',
                            month == 9 | month == 10 |month == 11 ~ 'autumn'))
df2$season <- as.factor(df2$season)
```
* With the help of the existing *starrating* variable new *class* variable was generated
```{r}
df2 <- df2 %>%
  mutate(class = case_when(starrating == 1.0 | starrating == 1.5 ~ 'tourist',
                           starrating == 2.0 | starrating == 2.5 ~ 'standard',
                           starrating == 3.0 | starrating == 3.5 ~ 'comfort',
                           starrating == 4.0 | starrating == 4.5 ~ 'first class',
                           starrating == 5.0 ~ 'luxury'))
df2$class <- as.factor(df2$class)
```

### • Quality of the dataset - missing values overview and frequency distribution of numeric values

```{r}
df2 %>% 
  skimr::skim_without_charts() 
```

## • Summary for the main variables in the transformed dataset
## *Numeric variables*
```{r echo=FALSE}
datasummary(distance + starrating + actualrating + trueprice ~ Mean + Min + Max + SD, data = df2) %>%
   kableExtra::kable_styling(latex_options = "hold_position")
```

### • Distance
### 75% of the hotels are located between 0 and 2.4 miles from the main city center. 
### The histogram below shows the distribution of the distances from the city center, the limit for x-axis was set at 25 miles.
```{r echo=FALSE}
ggplot(data=df2, aes(x=distance)) + geom_histogram(fill='navyblue', color='white', bins = 35) + 
  labs(x='Distance', y='Count')
```

### • Starrating
### Most of hotels from the dataset have 3 and 4 stars.
```{r echo=FALSE}
ggplot(data=df2, aes(x=starrating)) + geom_histogram(fill='navyblue', color='white', bins = 35) + 
  labs(x='Stars', y='Count') + xlim(1,5)
```

### • Actualrating
### As we can see from the histogram below, 80% of the guest reviews are between 3.4 and 4.1.
```{r echo=FALSE, message=FALSE}
ggplot(data=df2, aes(x=actualrating)) + geom_histogram(fill='navyblue', color='white') + 
  labs(x='Guest reviews', y='Count')
```

### • Trueprice
### 99% of the prices are below 600 EUR, thus, the limit for x-axis in histogram was set to this value.
### The distribution of the prices is skewed to the right, therefore, we can conclude that the mean price is greater then the mode.
```{r echo=FALSE, message=FALSE}
ggplot(data=df2, aes(x=trueprice)) + geom_histogram(fill='navyblue', color='white') + 
  labs(x='Price fpr one night (in EUR)', y='Count') + xlim(0, 600) 
```

### • Year and month
### 22636 records from the dataset are for the year 2017 and 32311 - for 2018.
```{r echo=FALSE}
kable(count(df2, year)) %>%
  kableExtra::kable_styling(position = "center", latex_options = "hold_position")
```

### Winter and spring are fully presented in the dataset, whereas there are no records for July, August, September, and October.

```{r echo=FALSE}
kable(count(df2, month)) %>%
  kableExtra::kable_styling(position = "center", latex_options = "hold_position")
```

## *Factor variables*

### • Accommodation type
### There are 16 unique accommodation types in the dataset. The most numerous types are "Hotel",  "Apartment", "Guest House",  and "Bed and Breakfast". Together they make up 93% of all records.
```{r echo=FALSE}
kable(count(df2,acctype_f) %>% arrange(desc(n))) %>%
  kableExtra::kable_styling(position = "center", latex_options = "hold_position")
```

### • Country
### The countries with the most records are Italy and Germany. Together they make up 66% of all records.
```{r}
kable(count(df2, country) %>% arrange(desc(n))) %>%
  kableExtra::kable_styling(position = "center", latex_options = "hold_position")
```

### • Season and class
### As we observed earlier, the dataset did not include two months for summer and two months for autumn, consequently, spring and winter have the most observations.
```{r echo=FALSE}
kable(count(df2, season) %>% arrange(desc(n))) %>%
  kableExtra::kable_styling(position = "center", latex_options = "hold_position")
```

### The most obsevations belong to 'comfort' class, which corresponds to 3 and 3.5 stars, and to 'first class', which corresponds to 4 and 4.5 stars.There are also 15889 missing values. They appeared, because the hotels with 0 stars were not used for the 'class' variable, as the mean price for them is higher than for places with 1, 1.5, 2, and 2.5 stars, which does not make sense. Therefore, these observations were omitted.
```{r echo=FALSE}
kable(count(df2, class)) %>%
  kableExtra::kable_styling(position = "center", latex_options = "hold_position")
```

```{r echo=FALSE}
data <- data.frame(
  class=c('comfort', 'first class', 'luxury', 'standard', 'tourist'),
  value=c(17695, 14154, 2307, 4025, 877)
)
data <- data %>% 
  arrange(desc(class)) %>%
  mutate(prop = value / sum(data$value) *100) %>%
  mutate(ypos = cumsum(prop)- 0.5*prop )

ggplot(data, aes(x="", y=prop, fill=class)) +
  geom_bar(stat="identity", width=1, color="white") +
  coord_polar("y", start=0) +
  theme_void() + 
  geom_text(aes(y = ypos, label = round(prop, 1)), color = "white", size=5) +
  scale_fill_brewer(palette="Set1") + labs(fill="Class")
```

## *Binary variables*

### • Weekend and holiday
### 36193 records were made on weekends (66%),  and 18754 - on weekdays (34%)

```{r echo=FALSE}
kable(count(df2, weekend)) %>%
  kableExtra::kable_styling(position = "center", latex_options = "hold_position")
```

### Only 21% (11728) of all observations were made on holidays.

```{r echo=FALSE}
kable(count(df2, holiday)) %>%
  kableExtra::kable_styling(position = "center", latex_options = "hold_position")
```

## 1.3 Findings. 
### For this project, we wanted to find the best deal among different types of accommodation in Central European countries. 
### Consequently, we formulated the question: 
* *How does the average price change for different values of explanatory variables?*

### • Mean prices for countries

```{r}
datasummary(trueprice*country ~ Mean + Max + Min, data=df2)%>%
  kableExtra::kable_styling(latex_options = "hold_position")
```

### • Plot for diff years diff countries
```{r}
df3 <- aggregate(trueprice ~ country + year, 
                 data=df2, 
                 function(x) { 
                   c(mean_price = mean(x)) 
                 })
ggplot(data = df3, aes(x=year, y=trueprice, fill=country)) + 
  geom_bar(stat='identity') + facet_wrap(~country) +
  geom_text(aes(label = round(trueprice)), vjust = -0.2) +
  scale_x_discrete() + ylim(0, 195) + 
  labs(x='Year(2017,2018)', y='Price for one night (in EUR)', fill='Country')
```

### • Mean prices for diff seasons
```{r echo=FALSE}
datasummary(trueprice*season ~ Mean, data=df2) %>%
   kableExtra::kable_styling(latex_options = "hold_position")
```

### • Plot for classes
```{r echo=FALSE}
datasummary(trueprice*class ~ Mean, data = df2) %>%
   kableExtra::kable_styling(latex_options = "hold_position")
```
```{r echo=FALSE, message=FALSE}
ggplot(data = df2, aes(x=reorder(class, +trueprice), y=trueprice, fill = class)) + 
  geom_bar(stat = 'summary') + labs(x='Class', y='Price for 1 night (in EUR)', fill = 'Class')
```
